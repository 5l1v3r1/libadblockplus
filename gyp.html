<html>
    <head>
        <title>gyp - The ABP External Documentation</title>
    </head>
    <body>
        <h1><tt>gyp</tt> - The ABP External Documentation</h1>
        <p>
            This page is substitute for proper <tt>gyp</tt> documentation.
            It's not that the existing <tt>gyp</tt> documentation is wrong,
                but rather that's it's woefully incomplete,
                which is arguably OK if your needs are simple, 
                but when is <i>that</i> ever the case?
        </p>
        
        <h2>Existing Documentation</h2>
        Here's what is already available for <tt>gyp</tt>.
        <ul>
            <li>
                The <a href="http://code.google.com/p/gyp/w/list">wiki for <tt>gyp</tt></a> on Google Code.
                The important pages are the three immediately following,
                    though the index on this page has links to other documentation that might be of interest.                                
            </li><li>
                Something of a <a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=585825">man page</a> for gyp, 
                    which usefully lists all the command line arguments. 
                The page itself is a Debian Bug report.
                Good for him (Jonathan Nieder, reporting);
                    lack of documentation is a defect just like bad behavior is.
            </li><li>
                <a href="">Input Format Reference</a> on the <tt>gyp</tt> wiki.
                This describes the syntax of the <tt>.gyp</tt> file.
                There's a rewriting system with macros, conditionals, <i>etc.</i>
                It's the moral equivalent of the C preprocessor,
                    though it doesn't seem there's a way of running just this phase.
            </li><li>
                <a href="">Language Specification</a> on the <tt>gyp</tt> wiki.
                This describes the semantics of the <tt>.gyp</tt> file
                    and the behavior of the <tt>gyp</tt> processor.
                This content here is analogous to a Makefile.  
            </li><li>
                <a href="http://code.google.com/p/gyp/wiki/GypUserDocumentation">User Documentation</a> on the <tt>gyp</tt> wiki.
                This is a compendium of examples and recipe snippets. 
                Useful for becoming familiar with <tt>gyp</tt>, 
                    but not so useful once you have to figure out something that's not here already.                  
            </li><li>
                <a href="http://code.google.com/p/gyp/issues/list">Issue Tracker</a>.
                You'll probably need to look here, 
                    though it's a shame that you'll usually need to look here.
                As of this writing (April 2013), half of the first ten issues are still active,
                    the most recent one (#10) is four years old,
                    and they are all specific to MSVS.                            
            </li>
        </ul>
        
        <h2>Code Generators for <tt>gyp</tt></h2>
        <p>
            One thing there's no official documentation at all on are the code generators,
                specific by the <tt>--format</tt> flag.
            There are a number of undocumented variables that affect the output;
                think of them as target configuration parameters.
        </p>
        
        <h3>Microsoft Visual Studio (MSVS) Code Generator</h3>
        <p>
            Invoke with <tt>--format=msvs</tt>.
        </p><p>
            The information here was extracted from the source code.
            The relevant code is in <tt>~gyp\pylib\gyp\MSVS*.py</tt> and <tt>~gyp\pylib\gyp\generator\msvs.py</tt>            
        </p>
        
        <h4>Command Generation</h4>
        <p>
            The default Chromium build requires cygwin, and evidently a not-completely-standard installation of it.
            So naturally there are a number of variables about cygwin itself, rather than anything more generic.
            Naturally.
        </p><p>
            Command lines within a project are generated by <tt>msvs.py:_BuildCommandLineForRuleRaw</tt>.
            It's third argument is <tt>cygwin_shell</tt>, a boolean flag indicate whether to generate cygwin commands.        
            It does crazy stuff like invoke <tt>`cygpath -m "${INTDIR}"`</tt>.
            Yes, it uses backticks and <tt>cygpath</tt> 
                when there's a perfectly good set of VC project variables that they could use as bases for relative paths
                and compute them at compile time Python <tt>os.path</tt>.
            It's also the routine that appends <tt>setup_env.bat</tt> to everything.
            So we want to avoid setting this flag if possible.
        </p><p>
            <tt>msvs.py:_BuildCommandLineForRuleRaw</tt> is called from two places: <tt>msvs.py:_BuildCommandLineForRule</tt> and <tt>msvs.py:_GenerateExternalRules</tt>.
            The first of these is the one used to process actions.
            It sets the <tt>cygwin_shell</tt> argument by examining the parameter <tt>msvs_cygwin_shell</tt>,
                both on the action and the target it's part of.
            Setting the parameter <tt>msvs_cygwin_shell</tt> to 0 (false) turns off the cygwin-specific command lines.
            As to the second one, that's used to generate makefiles and always sets the a parameter to "true".
            No way out there, even though Visual Studio comes with NMake, which would have made a reasonable substitute that didn't incur a dependency.
        </p><p>
            <tt>msvs.py:_BuildCommandLineForRule</tt> is called from three places: 
                <tt>msvs.py:_GenerateNativeRulesForMSVS</tt>, which makes <tt>.rules</tt> files,
                <tt>msvs.py:_AddActions</tt>, which handles the <tt>actions</tt> parameter that makes custom build instructions,
                and <tt>msvs.py:MSBuildRule</tt>, called in its constructor.
        </p><p>
            When <tt>msvs.py:_BuildCommandLineForRuleRaw</tt> is not using cygwin the path names for arguments are passed through a path transformer <tt>_FixPath</tt>.
            <tt>_FixPath</tt> does some cleanup on paths, since apparently paths are not sanitized to generic form when first read in.
            In addition to slash-backslash normalization, it also prepends the global variable <tt>_FixPath</tt>.
            Yes, a global variable of file scope.
            Apparently it was too much effort to know what the working directory for MSBuild in Visual Studio was, and so they just hacked it in.
            It does seem to work, but ...
        </p>
                
        <h4>Parameters</h4>
        Most of these were found with <tt>grep</tt>.
        Assuming that there's a completely consistent naming convention,
            this should be all the <tt>msvs_*</tt> parameters.
        Please note the words "assuming" and "should be" in the previous sentence.
        There are other parameters that affect code generation, however.
        Some may not be listed here. 
        <dl>
            <dt><tt>msvs_2010_disable_uldi_when_referenced</tt></dt>
            <dd>
                <p>
                    Do I even care what this is for?
                    No.
                    We're not supporting VS 2010 or earlier.
                    So there.
                </p>
            </dd>
            
            <dt><tt>msvs_auto_output_file</tt></dt>
            <dd>
                <p>
                    Used only once, in <tt>msvs.py:_GetOutputFilePathAndTool</tt>, to generate an output file path name.
                    Defaults to 1 (true); set to 0 to have this function return the empty string for output file and associated tools.
                </p>
                <p>
                    <dl>
                    The algorithm that generates the file name references a number of other parameters.
                        <dt><tt>product_dir</tt></dt>
                        <dd>
                            If present, sets the output directory and overrides the default.
                        </dd>
                        
                        <dt><tt>product_extension</tt></dt>
                        <dd>
                            If present, sets the file name suffix to "." plus the parameter.
                            If absent and using MSBuild (indicated by a function argument), uses "$(TargetExt)" as the suffix.
                            Otherwise, the suffix is derived from the rule type and is one of ".exe", ".dll", or ".lib". 
                        </dd>
                        
                        <dt><tt>product_name</tt></dt>
                        <dd>
                            If present, sets the file base name, to which prefix and suffix are added.
                            If absent, the file base name is "$(ProjectName)".
                        </dd>
                        
                        <dt><tt>product_prefix</tt></dt>
                        <dd>
                            If present, sets a file name prefix.
                            If absent, the prefix is empty.
                        </dd>
                        
                        <dt><tt>standalone_static_library</tt></dt>
                        <dd>
                            Defaults to 0 (false).
                            If false, the default output directory is derived from the rule type;
                                it is "$(OutDir)" for all but static libraries, for which it is "$(OutDir)lib\".
                            If true, sets the default output directory to "$(OutDir)".
                            The default output directory may be overridden by <tt>product_dir</tt>.
                        </dd>
                    </dl>
                </p>
            </dd>        
            
            <dt><tt>msvs_configuration_attributes</tt></dt>
            <dd>
                <p>
                    Effective only within a <tt>configurations</tt> attribute of a <tt>.gyp</tt> file.
                </p><p>
                    Found in <tt>msvs.py:_GetMSVSAttributes</tt>,
                        where it provides defaults for project attributes,
                        apparently even ones not on the list below.
                    The function ensure that a few attributes are always present in its return value.
                    <dl>
                        <dt><tt>ConfigurationType</tt></dt>
                        <dd><p>
                            The function sets it to its argument <tt>config_type</tt>.
                            It's not possible to override this with parameter <tt>msvs_configuration_attributes</tt>. 
                        </p></dd>
                        
                        <dt><tt>InheritedPropertySheets</tt></dt>
                        <dd><p>
                            Sets this property from the list specified by parameter <tt>msvs_props</tt>, if present.
                            If not present, it's uses whatever was already there, if anything.
                        </p></dd>
                        
                        <dt><tt>IntermediateDirectory</tt></dt>
                        <dd><p>
                            Overrides the default, which is <tt>$(OutDir)obj\$(ProjectName)\</tt>.
                            Who comes up with these defaults, anyway?
                            <span style="font-size:xx-small">*cough*Chrome*cough*</span>
                        </p></dd>
                        
                        <dt><tt>OutputDirectory</tt></dt>
                        <dd><p>
                            Overrides the default, which is <tt>'$(SolutionDir)$(ConfigurationName)</tt>.
                        </p></dd>
                    </dl>                      
                    
                </p><p>
                    Also found in <tt>msvs_emulation.py</tt>. 
                </p> 
            </dd>        
            
            <dt><tt>msvs_configuration_platform</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_cygwin_dirs</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_cygwin_shell</tt></dt>
            <dd>
                <p>
                    Boolean flag, indicating whether to generate command lines for cygwin or not.
                    Default is true.
                    Appears twice in <tt>msvs.py:_BuildCommandLineForRule</tt>,
                        once for the target and once for the action,
                        and determines the <tt>mcs</tt> argument in <tt>msvs.py:_BuildCommandLineForRuleRaw</tt>
                    A comment for the function specifically indicates that there's no way to set this at project scope,
                        because, as they say, "For now the behavior chrome needs is the default."
                </p> 
            </dd>        
            
            <dt><tt>msvs_disabled_warnings</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_error_on_missing_sources</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_existing_vcproj</tt></dt>
            <dd>
                <p>
                    This parameter is the name of a VC project file that already exists.
                    This parameter suppresses generation of a project file and incorporates this project file into the solution file.
                </p> 
            </dd>        
            
            <dt><tt>msvs_external_rule</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_folder</tt></dt>
            <dd>
                <p>
                    Found in <tt>MSVSNew.py</tt>.
                </p> 
            </dd>        
            
            <dt><tt>msvs_guid</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_list_excluded_files</tt></dt>
            <dd><p>
                This one's a generator flag.
                If true it adds all possible source files it finds to the project file, but as "excluded from build",
                    which could be useful for someone, but also generates a lot of entries for standard libraries that are just clutter.
                The default is true, however, and since it's a generator flag, you can't put it into the configuation file itself.                
            </p></dd>        

            <dt><tt>msvs_new</tt></dt>
            <dd>
                <p>
                    Found in <tt>MSVSNew.py</tt>.
                </p> 
            </dd>        
            
            <dt><tt>msvs_postbuild</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_prebuild</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_precompiled_header</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_precompiled_source</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_props</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_quote_cmd</tt></dt>
            <dd>
                <p>
                    In the same place as <tt>msvs_cygwin_shell</tt>, there's <tt>msvs_quote_cmd</tt>,
                        which defaults to true.
                    It puts double quotes around each "argument", 
                        and that word is in quote marks because there's a catch.
                    Strings are quoted as whole strings,
                        but arguments that consist only of a single list variable expansion are quoted separately. 
                </p><p>
                    <tt>msvs_quote_cmd</tt> is only looked for on the rule itself.
                    It appears once in <tt>msvs.py:_BuildCommandLineForRule</tt>.
                </p> 
            </dd>        
            
            <dt><tt>msvs_settings</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_shard</tt></dt>
            <dd>
                <p>
                    Found in <tt>MSVSUtil.py</tt>.
                </p> 
            </dd>        
            
            <dt><tt>msvs_system_include_dirs</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_target_platform</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_tool_files</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
            
            <dt><tt>msvs_version</tt></dt>
            <dd>
                <p>
                </p> 
            </dd>        
        </dl> 

        <h4>Guide to the Source Code</h4>
        <p>
            You've got to read the source code to learn anything about the generator.
            Here are the source files involved.
            The paths are all relative to the <tt>gyp</tt> base directory.
        </p>
        <dl>
            <dt><tt>pylib/gyp/generator/msvs.py</tt></dt>
            <dd>
                <p>
                    This is where the bulk of the configuration logic goes.
                    It doesn't handle the syntax of project files;
                        that's in the <tt>MSVS*.py</tt> sources.
                    Almost all of the configuration parameters listed above are found here.
                </p>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSNew.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSProject.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSSettings.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSToolFile.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSUserFile.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSUtil.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/MSVSVersion.py</tt></dt>
            <dd>
            </dd>
            
            <dt><tt>pylib/gyp/msvs_emulation.py</tt></dt>
            <dd>
                <p>
                    Here's what the documentation at the top of this file says.
                    I haven't looked any farther than this.
                    <pre style="border: 1px solid"><code>
  This module helps emulate Visual Studio 2008 behavior on top of other
  build systems, primarily ninja.
                    </code></pre>
                    Sound like out of the frying pan and into fire, if you were to ask me.
                </p>
            </dd>

        </dl>

        <h4>Restrictions arising from the <tt>msvs</tt> generator</h4>
        <p>
            There are a couple of restrictions on <tt>.gyp</tt> specifications
                that arise from boneheaded behavior in this generator.
            Here they are, with explanations.
        </p>
        <ul>
            <li>
                All command line tools have to have arguments that 
                    either (a) begin with a hyphen or slash, 
                    or (b) are path names.
            </li>
            <p>
                The generator has to "fix up" command lines in order to get all the paths correct.
                When it does this, it assumes that everything is a path unless it looks like an option flag,
                    that is, unless it begins with a hyphen or a slash.
                This is a combination of a design deficiency in gyp and stupidity on the part of the generator. 
                Even though there are perfectly good arguments to an action listing the dependencies, 
                    there's no part of the specification that directly links these dependencies, 
                    and there's no syntax defined to handle the case (as we have) 
                    that the dependencies don't all appear in a single list on the command line.
                In other words, even though there's something analogous to a type declaration for file dependencies,
                    it's ignored when specifying the command line for an action.
                The generator does nothing to overcome this deficiency. 
                It doesn't bother to do anything like finding the dependencies as sub-strings in the command line and fixing just those strings. 
                Oh no. 
                Instead it just assumes everything is a path, which (damning with faint praise) at least finds all the dependencies.            
            </p>
            <li>
                You have to ensure that list expansion in <tt>action</tt> elements is done in individual list elements, not within a larger string.
            </li>
            <p>
                This all has to do with how quoting is handled.
                Consider the examples <tt>[ ... '--convert <@(files)', ... ]</tt> versus <tt>[ ... '--convert', '<@(files)', ... ]</tt>.
                The first has one list element; the second, two.
                In the first, list substitution is done first and then the string as a whole is quoted, 
                    which is basically never what you want if the list contains filenames.
                In the second, each element of <tt>files</tt> is quoted separately.
                (In addition, <tt>--convert</tt> is quoted, which is completely useless, yet harmless.)            
            </p>
        </ul>
    
        <h2>Revision History</h2>
        Original version written in April 2013 by Eric Hughes.
        References to the <tt>gyp</tt> source code are, by default, from its then-current version.         
    </body>
</html>